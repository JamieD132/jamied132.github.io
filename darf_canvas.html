<!doctype html>
<head>
  <title>Darflen Canvas Archives</title>
</head>
<body>
  <h1>Darflen canvas archives</h1>
  <p>Darflen Canvas Archives is basically just wayback machine but for <a href="https://darflen.com/canvas">Darflen Canvas</a>. Please do not save a canvas if no change is made.</p>
  <h2>Current canvas</h2>
  <canvas id="current_canvas" width="128" height="128"></canvas>
  <button id="save_canvas" onclick="save()" disabled>Loading...</button>
  <h2>Saved canvases</h2>
  <div id="saved_canvases"></div>
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" crossorigin="anonymous" type="text/javascript"></script>
  <script>
    var hex = /^#(?:[0-9a-fA-F]{3}){1,2}$/;
    const socket = io("wss://api.darflen.com/canvas", {
        path: "/ws/",
        transports: ["websocket", "polling"],
        withCredentials: true,
    });
    socket.on("connect", () => {
        socket.emit("request_canvas");
    });
    function draw(data){
      var canvas = document.querySelector('canvas');
      var ctx = canvas.getContext('2d');
      for(let y = 0; y< grid_size;y++){
        for(let x=0;x<grid_size;x++){
          ctx.fillStyle=hex.test(data[y*grid_size+x])?data[y*grid_size+x]:"#ffffff";
          ctx.fillRect(x,y,1,1);
        }
      }
    }
    grid_size = 128;
    grid_data = new Array(grid_size*grid_size);
    socket.on("update_bulk", (stuff) => {
        for (const { x, y, data } of stuff) {
            grid_data[y * grid_size + x] = data.color;
        }
        draw(grid_data);
        document.querySelector('#save_canvas').innerHTML='Save Current Canvas';
        document.querySelector('#save_canvas').removeAttribute('disabled');
    });
    fetch('https://api.jamied132.is-a.dev/getCanvas').then(r=>r.json()).then(j=>{
      var imgs = ``;
      j.forEach(i=>{
        imgs+=`
        <div class="saved_canvas">
          <img src="${i.canvas}">
          <span>${(new Date(i.date)).toLocaleString()}</span>
        </div>
        `;
      });
      document.querySelector("#saved_canvases").innerHTML=imgs;
    });
    function save(){
      document.querySelector('#save_canvas').innerHTML='Saving...';
      document.querySelector('#save_canvas').setAttribute('disabled','true');
      fetch('https://api.jamied132.is-a.dev/saveCanvas',{
        method:'POST',
        body:document.querySelector('canvas').toDataURL()
      }).then(r=>{
        document.querySelector('#save_canvas').innerHTML='Saved';
      });
    }
  </script>
  <style>
    canvas,img{
      image-rendering:pixelated;
    }
    div#saved_canvases {
    width: 100%;
}

.saved_canvas {
    width: 128px;
    background-color: lightblue;
    border-radius: 5px;
    padding: 5px;
    float: left;
    margin: 5px;
}

span {
    font-weight: bold;
    font-size: 14px;
    text-align: center;
    display: inline-block;
}

body {
    font-family: sans-serif;
}

canvas#current_canvas {
    border: 1px solid black;
}

button#save_canvas {
    display: block;
}
  </style>
</body>
